{% extends "production_quality/base.html" %}
{% load static %}

{% block title %}é…ç½®å›¢é˜Ÿ - {{ project.name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'production_quality_pages:production_startup_list' %}">ç”Ÿäº§å¯åŠ¨</a></li>
<li class="breadcrumb-item"><a href="{% url 'production_quality_pages:production_startup_detail' startup.id %}">è¯¦æƒ…</a></li>
<li class="breadcrumb-item active">é…ç½®å›¢é˜Ÿ</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="center-hero">
        <div class="hero-icon">ğŸ‘¥</div>
        <h1 class="hero-title">é…ç½®å›¢é˜Ÿ</h1>
        <p class="hero-subtitle">{{ project.name }}ï¼ˆ{{ project.project_number }}ï¼‰</p>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">å½“å‰å›¢é˜Ÿæˆå‘˜</h5>
        </div>
        <div class="card-body">
            {% if team_members %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>è§’è‰²</th>
                            <th>ä¸“ä¸š</th>
                            <th>æ‰€å±å›¢é˜Ÿ</th>
                            <th>åŠ å…¥æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in team_members %}
                        <tr>
                            <td>{{ member.user.get_full_name|default:member.user.username }}</td>
                            <td>{{ member.get_role_display }}</td>
                            <td>{{ member.service_profession.name|default:"--" }}</td>
                            <td>{{ member.get_unit_display }}</td>
                            <td>{{ member.join_date|date:"Y-m-d" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center mb-0">æš‚æ— å›¢é˜Ÿæˆå‘˜</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">æ·»åŠ å›¢é˜Ÿæˆå‘˜</h5>
        </div>
        <div class="card-body">
            <form method="post" id="teamForm">
                {% csrf_token %}
                <div id="teamMembersContainer">
                    <div class="team-member-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label required">é€‰æ‹©äººå‘˜</label>
                                <select name="team_members" class="form-select" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    {% for user in available_users %}
                                    <option value="{{ user.id }}">
                                        {{ user.get_full_name|default:user.username }}
                                        {% if user.department %}ï¼ˆ{{ user.department.name }}ï¼‰{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">è§’è‰²</label>
                                <select name="roles" class="form-select" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    <option value="professional_leader">ä¸“ä¸šè´Ÿè´£äºº</option>
                                    <option value="engineer">ä¸“ä¸šå·¥ç¨‹å¸ˆ</option>
                                    <option value="technical_assistant">æŠ€æœ¯åŠ©ç†</option>
                                    <option value="cost_engineer_civil">åœŸå»ºé€ ä»·å¸ˆ</option>
                                    <option value="cost_engineer_installation">å®‰è£…é€ ä»·å¸ˆ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ä¸“ä¸š</label>
                                <select name="professions" class="form-select">
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    {% for profession in service_professions %}
                                    <option value="{{ profession.id }}">{{ profession.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="addTeamMember()">+ æ·»åŠ æˆå‘˜</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                    <a href="{% url 'production_quality_pages:production_startup_detail' startup.id %}" class="btn btn-secondary">è¿”å›</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let memberIndex = 1;

function addTeamMember() {
    const container = document.getElementById('teamMembersContainer');
    const template = container.querySelector('.team-member-item').cloneNode(true);
    
    // é‡ç½®é€‰æ‹©æ¡†
    template.querySelectorAll('select').forEach(select => {
        select.value = '';
        select.name = select.name.replace(/\[\d+\]/, '') + '[]';
    });
    
    // æ·»åŠ åˆ é™¤æŒ‰é’®
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn btn-sm btn-danger mt-2';
    deleteBtn.textContent = 'åˆ é™¤';
    deleteBtn.onclick = function() {
        this.closest('.team-member-item').remove();
    };
    template.appendChild(deleteBtn);
    
    container.appendChild(template);
    memberIndex++;
}
</script>
{% endblock %}

