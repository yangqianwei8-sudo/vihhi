{% extends "production_quality/base.html" %}
{% load static %}

{% block title %}ä»»åŠ¡æ¸…å• - {{ project.name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'production_quality_pages:production_startup_list' %}">ç”Ÿäº§å¯åŠ¨</a></li>
<li class="breadcrumb-item"><a href="{% url 'production_quality_pages:production_startup_detail' startup.id %}">è¯¦æƒ…</a></li>
<li class="breadcrumb-item active">ä»»åŠ¡æ¸…å•</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="center-hero">
        <div class="hero-icon">ğŸ“‹</div>
        <h1 class="hero-title">ä»»åŠ¡æ¸…å•</h1>
        <p class="hero-subtitle">{{ project.name }}ï¼ˆ{{ project.project_number }}ï¼‰</p>
    </div>

    <div class="alert alert-info">
        <strong>æç¤ºï¼š</strong>
        <ul class="mb-0">
            <li>ä»»åŠ¡èŠ‚çœç›®æ ‡æ€»é¢å¿…é¡»å¤§äºç­‰äºåˆåŒç›®æ ‡çš„1.5å€</li>
            <li>åˆåŒç›®æ ‡ï¼šÂ¥{{ contract_saving_target|floatformat:2 }}</li>
            <li>æœ€ä½è¦æ±‚ï¼šÂ¥{{ required_saving_target|floatformat:2 }}</li>
        </ul>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">ä»»åŠ¡åˆ†è§£</h5>
        </div>
        <div class="card-body">
            <form method="post" id="tasksForm">
                {% csrf_token %}
                <div id="tasksContainer">
                    {% for task in task_breakdowns %}
                    <div class="task-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label required">ä»»åŠ¡åç§°</label>
                                <input type="text" name="task_name" class="form-control" value="{{ task.task_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">æ‰€å±ä¸“ä¸š</label>
                                <select name="profession_id" class="form-select" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    {% for profession in service_professions %}
                                    <option value="{{ profession.id }}" {% if task.profession_id == profession.id %}selected{% endif %}>
                                        {{ profession.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">åˆ†é…äººå‘˜</label>
                                <select name="assigned_to_id" class="form-select">
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    {% for member in team_members %}
                                    <option value="{{ member.user.id }}" {% if task.assigned_to_id == member.user.id %}selected{% endif %}>
                                        {{ member.user.get_full_name|default:member.user.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">å»ºç­‘é¢ç§¯ï¼ˆã¡ï¼‰</label>
                                <input type="number" name="building_area" class="form-control" step="0.01" value="{{ task.building_area|default:'' }}">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">æ¯å¹³æ–¹ç±³èŠ‚çœé‡‘é¢ï¼ˆå…ƒ/ã¡ï¼‰</label>
                                <input type="number" name="saving_target_per_sqm" class="form-control" step="0.01" value="{{ task.saving_target_per_sqm|default:'' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ä»»åŠ¡å†…å®¹</label>
                                <textarea name="task_content" class="form-control" rows="2">{{ task.task_content }}</textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeTask(this)">åˆ é™¤ä»»åŠ¡</button>
                    </div>
                    {% empty %}
                    <div class="task-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label required">ä»»åŠ¡åç§°</label>
                                <input type="text" name="task_name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">æ‰€å±ä¸“ä¸š</label>
                                <select name="profession_id" class="form-select" required>
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    {% for profession in service_professions %}
                                    <option value="{{ profession.id }}">{{ profession.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">åˆ†é…äººå‘˜</label>
                                <select name="assigned_to_id" class="form-select">
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    {% for member in team_members %}
                                    <option value="{{ member.user.id }}">{{ member.user.get_full_name|default:member.user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">å»ºç­‘é¢ç§¯ï¼ˆã¡ï¼‰</label>
                                <input type="number" name="building_area" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">æ¯å¹³æ–¹ç±³èŠ‚çœé‡‘é¢ï¼ˆå…ƒ/ã¡ï¼‰</label>
                                <input type="number" name="saving_target_per_sqm" class="form-control" step="0.01">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ä»»åŠ¡å†…å®¹</label>
                                <textarea name="task_content" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeTask(this)">åˆ é™¤ä»»åŠ¡</button>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="addTask()">+ æ·»åŠ ä»»åŠ¡</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜ä»»åŠ¡æ¸…å•</button>
                    <a href="{% url 'production_quality_pages:production_startup_detail' startup.id %}" class="btn btn-secondary">è¿”å›</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function addTask() {
    const container = document.getElementById('tasksContainer');
    const template = container.querySelector('.task-item').cloneNode(true);
    
    // é‡ç½®æ‰€æœ‰è¾“å…¥
    template.querySelectorAll('input, select, textarea').forEach(input => {
        if (input.type === 'text' || input.type === 'number') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else if (input.tagName === 'TEXTAREA') {
            input.value = '';
        }
    });
    
    container.appendChild(template);
}

function removeTask(btn) {
    const container = document.getElementById('tasksContainer');
    if (container.children.length > 1) {
        btn.closest('.task-item').remove();
    } else {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªä»»åŠ¡');
    }
}

document.getElementById('tasksForm').addEventListener('submit', function(e) {
    const tasks = document.querySelectorAll('.task-item');
    const tasksData = [];
    
    tasks.forEach(task => {
        const taskName = task.querySelector('input[name="task_name"]').value;
        const professionId = task.querySelector('select[name="profession_id"]').value;
        
        if (taskName && professionId) {
            tasksData.push({
                task_name: taskName,
                profession_id: professionId,
                assigned_to_id: task.querySelector('select[name="assigned_to_id"]').value,
                building_area: task.querySelector('input[name="building_area"]').value,
                saving_target_per_sqm: task.querySelector('input[name="saving_target_per_sqm"]').value,
                task_content: task.querySelector('textarea[name="task_content"]').value,
                scope: []
            });
        }
    });
    
    if (tasksData.length === 0) {
        e.preventDefault();
        alert('è¯·è‡³å°‘åˆ›å»ºä¸€ä¸ªä»»åŠ¡');
        return;
    }
    
    // åˆ›å»ºéšè—å­—æ®µæäº¤æ•°æ®
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'tasks_data';
    hiddenInput.value = JSON.stringify(tasksData);
    this.appendChild(hiddenInput);
});
</script>
{% endblock %}

