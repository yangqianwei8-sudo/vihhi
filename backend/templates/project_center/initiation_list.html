{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% block extra_head %}
<style>
    :root {
        --vh-primary: #142F5B;
        --vh-accent: #D62828;
        --vh-surface: #F6F7FD;
        --vh-border: #E4E8F4;
    }
    
    .page-header {
        background: linear-gradient(135deg, rgba(20,47,91,0.95), rgba(31,62,124,0.92));
        border-radius: 24px;
        padding: 32px 36px;
        color: #fff;
        box-shadow: 0 24px 60px rgba(20, 47, 91, 0.18);
        margin-bottom: 24px;
    }
    
    .content-card {
        background: #fff;
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 12px 32px rgba(20, 47, 91, 0.08);
        border: 1px solid var(--vh-border);
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-draft { background: #e5e7eb; color: #374151; }
    .status-waiting_initiation_approval { background: #dbeafe; color: #1e40af; }
    .status-initiation_approved { background: #d1fae5; color: #065f46; }
    .status-initiation_rejected { background: #fee2e2; color: #991b1b; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="page-header">
        <div style="font-size: 32px; margin-bottom: 12px;">{{ page_icon }}</div>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
                <p style="font-size: 14px; opacity: 0.9; margin: 0;">{{ description }}</p>
            </div>
            <div>
                <a href="{% url 'home' %}" class="btn btn-outline-primary me-2">
                    <i class="bi bi-house"></i> 返回首页
                </a>
                <a href="{% url 'project_pages:project_initiation_create' %}" class="btn btn-light">
                    <i class="bi bi-plus-circle"></i> 新建项目立项
                </a>
            </div>
        </div>
    </div>
    
    <!-- 列表 -->
    <div class="content-card">
        {% if projects %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>项目编号</th>
                        <th>项目名称</th>
                        <th>立项凭证类型</th>
                        <th>委托单位</th>
                        <th>设计单位</th>
                        <th>我方单位</th>
                        <th>状态</th>
                        <th>创建人</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr>
                        <td><strong>{{ project.project_number|default:"待生成" }}</strong></td>
                        <td>{{ project.name }}</td>
                        <td>{{ project.get_initiation_document_type_display|default:"-" }}</td>
                        <td>{{ project.client_company_name|default:"-" }}</td>
                        <td>{{ project.design_company|default:"-" }}</td>
                        <td>{{ project.our_company_name|default:"-" }}</td>
                        <td>
                            <span class="status-badge status-{{ project.status }}">
                                {{ project.get_status_display }}
                            </span>
                        </td>
                        <td>{{ project.created_by.get_full_name|default:project.created_by.username }}</td>
                        <td>{{ project.created_time|date:"Y-m-d H:i" }}</td>
                        <td>
                            <a href="{% url 'project_pages:project_initiation_detail' project.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> 查看
                            </a>
                            {% if project.status == 'draft' and project.created_by == user %}
                            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="deleteProject({{ project.id }}, '{{ project.name|escapejs }}')">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <p>暂无项目立项记录</p>
            <a href="{% url 'project_pages:project_initiation_create' %}" class="btn btn-primary mt-3">
                <i class="bi bi-plus-circle"></i> 创建项目立项
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock content %}

{% block extra_scripts %}
<script>
function deleteProject(projectId, projectName) {
    if (!confirm('确定要删除项目"' + projectName + '"吗？\n\n此操作不可恢复！')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 删除中...';
    
    const url = '{% url "project_pages:project_initiation_delete" 0 %}'.replace('0', projectId);
    // 获取 CSRF token
    let csrftoken = '';
    const csrfCookie = document.cookie.match(/csrftoken=([^;]+)/);
    if (csrfCookie) {
        csrftoken = csrfCookie[1];
    } else {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrftoken = csrfInput.value;
        }
    }
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || '删除成功');
            location.reload();
        } else {
            alert(data.message || '删除失败');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('删除失败，请稍后重试');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}
</script>
{% endblock extra_scripts %}

