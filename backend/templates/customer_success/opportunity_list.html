{% extends "customer_success/base.html" %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block extra_css %}
<style>
    .opportunity-nav {
        background: #fff;
        border-radius: 12px;
        padding: 0;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .opportunity-table {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .table {
        margin-bottom: 0;
    }
    .table thead th {
        background: #f9fafb;
        border-bottom: 2px solid #e5e7eb;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .table tbody td {
        font-size: 13px;
        vertical-align: middle;
    }
    .badge-status {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
    }
    .badge-potential { background: #f3f4f6; color: #374151; }
    .badge-initial_contact { background: #dbeafe; color: #1e40af; }
    .badge-requirement_confirmed { background: #fef3c7; color: #92400e; }
    .badge-quotation { background: #ddd6fe; color: #5b21b6; }
    .badge-negotiation { background: #fce7f3; color: #9f1239; }
    .badge-won { background: #d1fae5; color: #065f46; }
    .badge-lost { background: #fee2e2; color: #991b1b; }
    .badge-cancelled { background: #f3f4f6; color: #6b7280; }
    .badge-urgency {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }
    .badge-normal { background: #e5e7eb; color: #374151; }
    .badge-urgent { background: #fef3c7; color: #92400e; }
    .badge-very_urgent { background: #fee2e2; color: #991b1b; }
    .health-score {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .health-score.high { color: #16a34a; }
    .health-score.medium { color: #d97706; }
    .health-score.low { color: #dc2626; }
    .filter-bar {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">{{ page_title }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <div class="hero-icon">{{ page_icon }}</div>
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">{{ description }}</p>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    {% if summary_cards %}
    <div class="row mb-4">
        {% for card in summary_cards %}
        <div class="col-md-3 mb-3">
            <div class="summary-card">
                <h3>{{ card.label }}</h3>
                <p class="summary-value">{{ card.value }}</p>
                <p class="summary-hint">{{ card.hint }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ç­›é€‰æ  -->
    <div class="filter-bar">
        <form method="get" action="{% url 'business_pages:opportunity_management' %}" class="row g-3">
            <div class="col-md-3">
                <input type="text" name="search" class="form-control" placeholder="æœç´¢å•†æœºç¼–å·ã€åç§°ã€é¡¹ç›®ã€å®¢æˆ·..." value="{{ search }}">
            </div>
            <div class="col-md-2">
                <select name="status" class="form-select">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="client_id" class="form-select">
                    <option value="">å…¨éƒ¨å®¢æˆ·</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}" {% if client_id == client.id|stringformat:"s" %}selected{% endif %}>{{ client.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="urgency" class="form-select">
                    <option value="">å…¨éƒ¨ç´§æ€¥ç¨‹åº¦</option>
                    {% for value, label in urgency_choices %}
                    <option value="{{ value }}" {% if urgency == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary me-2">æœç´¢</button>
                <a href="{% url 'business_pages:opportunity_management' %}" class="btn btn-outline-secondary">é‡ç½®</a>
                <a href="{% url 'business_pages:opportunity_create' %}" class="btn btn-success ms-2">æ–°å»ºå•†æœº</a>
            </div>
        </form>
    </div>

    <!-- å•†æœºåˆ—è¡¨ -->
    <div class="opportunity-table">
        {% if page_obj %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>å•†æœºç¼–å·</th>
                    <th>å•†æœºåç§°</th>
                    <th>å…³è”å®¢æˆ·</th>
                    <th>é¡¹ç›®åç§°</th>
                    <th>é¢„è®¡é‡‘é¢</th>
                    <th>æˆåŠŸæ¦‚ç‡</th>
                    <th>åŠ æƒé‡‘é¢</th>
                    <th>çŠ¶æ€</th>
                    <th>ç´§æ€¥ç¨‹åº¦</th>
                    <th>å¥åº·åº¦</th>
                    <th>è´Ÿè´£å•†åŠ¡</th>
                    <th>é¢„è®¡ç­¾çº¦</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for opportunity in page_obj %}
                <tr>
                    <td><strong>{{ opportunity.opportunity_number|default:"æœªç¼–å·" }}</strong></td>
                    <td>{{ opportunity.name }}</td>
                    <td>{{ opportunity.client.name }}</td>
                    <td>{{ opportunity.project_name|default:"â€”" }}</td>
                    <td>Â¥{{ opportunity.estimated_amount|floatformat:2 }}ä¸‡</td>
                    <td>{{ opportunity.success_probability }}%</td>
                    <td><strong>Â¥{{ opportunity.weighted_amount|floatformat:2 }}ä¸‡</strong></td>
                    <td>
                        <span class="badge-status badge-{{ opportunity.status }}">
                            {{ opportunity.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <span class="badge-urgency badge-{{ opportunity.urgency }}">
                            {{ opportunity.get_urgency_display }}
                        </span>
                    </td>
                    <td>
                        <span class="health-score {% if opportunity.health_score >= 80 %}high{% elif opportunity.health_score >= 60 %}medium{% else %}low{% endif %}">
                            {% if opportunity.health_score >= 80 %}ğŸŸ¢{% elif opportunity.health_score >= 60 %}ğŸŸ¡{% else %}ğŸ”´{% endif %}
                            {{ opportunity.health_score }}åˆ†
                        </span>
                    </td>
                    <td>{{ opportunity.business_manager.get_full_name|default:opportunity.business_manager.username }}</td>
                    <td>{{ opportunity.expected_sign_date|default:"â€”"|date:"Y-m-d" }}</td>
                    <td>
                        <a href="{% url 'business_pages:opportunity_detail' opportunity.id %}" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹</a>
                        {% if opportunity.business_manager == user or user.is_superuser %}
                        <a href="{% url 'business_pages:opportunity_edit' opportunity.id %}" class="btn btn-sm btn-outline-secondary">ç¼–è¾‘</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- åˆ†é¡µ -->
        {% if page_obj.has_other_pages %}
        <div class="pagination p-3">
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if client_id %}&client_id={{ client_id }}{% endif %}{% if urgency %}&urgency={{ urgency }}{% endif %}">&laquo; é¦–é¡µ</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if client_id %}&client_id={{ client_id }}{% endif %}{% if urgency %}&urgency={{ urgency }}{% endif %}">ä¸Šä¸€é¡µ</a>
                {% endif %}

                <span class="current">
                    ç¬¬ {{ page_obj.number }} é¡µï¼Œå…± {{ page_obj.paginator.num_pages }} é¡µ
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if client_id %}&client_id={{ client_id }}{% endif %}{% if urgency %}&urgency={{ urgency }}{% endif %}">ä¸‹ä¸€é¡µ</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if client_id %}&client_id={{ client_id }}{% endif %}{% if urgency %}&urgency={{ urgency }}{% endif %}">æœ«é¡µ &raquo;</a>
                {% endif %}
            </span>
        </div>
        {% endif %}
        {% else %}
        <div class="p-5 text-center text-muted">
            <p>æš‚æ— å•†æœºæ•°æ®</p>
            <a href="{% url 'business_pages:opportunity_create' %}" class="btn btn-primary">åˆ›å»ºç¬¬ä¸€ä¸ªå•†æœº</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

