{% extends "customer_success/base.html" %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_management' %}">商机管理</a></li>
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_detail' opportunity.id %}">{{ opportunity.name }}</a></li>
<li class="breadcrumb-item active">状态流转</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <div class="hero-icon">{{ page_icon }}</div>
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">{{ description }}</p>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="form-label">当前状态</label>
                    <div class="alert alert-info">
                        <strong>{{ opportunity.get_status_display }}</strong>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label required-field">目标状态</label>
                    <select name="target_status" class="form-select" required>
                        <option value="">请选择目标状态</option>
                        {% for value, label in status_choices %}
                        {% if value in valid_transitions %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <div class="form-text">只能选择允许的状态</div>
                </div>

                {% if opportunity.status == 'negotiation' %}
                <div id="winFields" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">实际签约金额（万元）</label>
                        <input type="number" name="actual_amount" class="form-control" step="0.01" value="{{ opportunity.actual_amount|default:'' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">合同编号</label>
                        <input type="text" name="contract_number" class="form-control" value="{{ opportunity.contract_number|default:'' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">赢单原因</label>
                        <textarea name="win_reason" class="form-control" rows="3">{{ opportunity.win_reason|default:'' }}</textarea>
                    </div>
                </div>
                {% endif %}

                <div class="mb-4">
                    <label class="form-label">备注说明</label>
                    <textarea name="comment" class="form-control" rows="3" placeholder="请输入状态流转的备注说明"></textarea>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{% url 'business_pages:opportunity_detail' opportunity.id %}" class="btn btn-outline-secondary">取消</a>
                    <button type="submit" class="btn btn-primary">确认流转</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.querySelector('select[name="target_status"]').addEventListener('change', function() {
    const winFields = document.getElementById('winFields');
    if (this.value === 'won' && winFields) {
        winFields.style.display = 'block';
    } else if (winFields) {
        winFields.style.display = 'none';
    }
});
</script>
{% endblock %}

